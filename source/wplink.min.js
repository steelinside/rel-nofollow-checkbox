var wpLink;(function(e){var t,n,r,i,s={},o={},u="ontouchend"in document;wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",FancyLink:function(){var t='<div><label><span> </span><input type="checkbox" id="fancy-link-checkbox" />&nbsp;Fancy Link</label></div>';e(t).insertAfter("#wp-link .link-target");e("#wp-link-wrap").css("min-height","310px")},init:function(){s.wrap=e("#wp-link-wrap");s.dialog=e("#wp-link");s.backdrop=e("#wp-link-backdrop");s.submit=e("#wp-link-submit");s.close=e("#wp-link-close");s.url=e("#url-field");s.nonce=e("#_ajax_linking_nonce");s.fsFancyLink=e("#fancy-link-checkbox");s.title=e("#link-title-field");s.openInNewTab=e("#link-target-checkbox");s.search=e("#search-field");o.search=new r(e("#search-results"));o.recent=new r(e("#most-recent-results"));o.elements=s.dialog.find(".query-results");s.queryNotice=e("#query-notice-message");s.queryNoticeTextDefault=s.queryNotice.find(".query-notice-default");s.queryNoticeTextHint=s.queryNotice.find(".query-notice-hint");s.dialog.keydown(wpLink.keydown);s.dialog.keyup(wpLink.keyup);s.submit.click(function(e){e.preventDefault();wpLink.update()});s.close.add(s.backdrop).add("#wp-link-cancel a").click(function(e){e.preventDefault();wpLink.close()});e("#wp-link-search-toggle").on("click",wpLink.toggleInternalLinking);o.elements.on("river-select",wpLink.updateFields);s.search.on("focus.wplink",function(){s.queryNoticeTextDefault.hide();s.queryNoticeTextHint.removeClass("screen-reader-text").show()}).on("blur.wplink",function(){s.queryNoticeTextDefault.show();s.queryNoticeTextHint.addClass("screen-reader-text").hide()});s.search.keyup(function(){var e=this;window.clearTimeout(n);n=window.setTimeout(function(){wpLink.searchInternalLinks.call(e)},500)})},open:function(n){var r;wpLink.range=null;if(n){window.wpActiveEditor=n}if(!window.wpActiveEditor){return}this.textarea=e("#"+window.wpActiveEditor).get(0);if(typeof tinymce!=="undefined"){r=tinymce.get(wpActiveEditor);if(r&&!r.isHidden()){t=r}else{t=null}if(t&&tinymce.isIE){t.windowManager.bookmark=t.selection.getBookmark()}}if(!wpLink.isMCE()&&document.selection){this.textarea.focus();this.range=document.selection.createRange()}s.wrap.show();s.backdrop.show();wpLink.refresh();e(document).trigger("wplink-open",s.wrap)},isMCE:function(){return t&&!t.isHidden()},refresh:function(){o.search.refresh();o.recent.refresh();if(wpLink.isMCE()){wpLink.mceRefresh()}else{wpLink.setDefaultValues()}if(u){s.url.focus().blur()}else{s.url.focus()[0].select()}if(!o.recent.ul.children().length){o.recent.ajax()}},mceRefresh:function(){var e;if(e=t.dom.getParent(t.selection.getNode(),"A")){s.url.val(t.dom.getAttrib(e,"href"));s.title.val(t.dom.getAttrib(e,"title"));s.openInNewTab.prop("checked","_blank"===t.dom.getAttrib(e,"target"));s.fsFancyLink.prop("checked","fancy-link"==t.dom.getAttrib(e,"class"));s.submit.val(wpLinkL10n.update)}else{wpLink.setDefaultValues()}},close:function(){if(!wpLink.isMCE()){wpLink.textarea.focus();if(wpLink.range){wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select()}}else{t.focus()}s.backdrop.hide();s.wrap.hide();e(document).trigger("wplink-close",s.wrap)},getAttrs:function(){return{href:s.url.val(),title:s.title.val(),target:s.openInNewTab.prop("checked")?"_blank":"","class":s.fsFancyLink.prop("checked")?"fancy-link":""}},update:function(){if(wpLink.isMCE()){wpLink.mceUpdate()}else{wpLink.htmlUpdate()}},htmlUpdate:function(){var e,t,n,r,i,s,o,u=wpLink.textarea;if(!u){return}e=wpLink.getAttrs();if(!e.href||e.href=="http://"){return}t='<a href="'+e.href+'"';if(e.title){s=e.title.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");t+=' title="'+s+'"'}if(e.target){t+=' target="'+e.target+'"'}if(e.class){t+=' class="fancy-link"'}t+=">";if(document.selection&&wpLink.range){u.focus();wpLink.range.text=t+wpLink.range.text+"</a>";wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select();wpLink.range=null}else{if(typeof u.selectionStart!=="undefined"){n=u.selectionStart;r=u.selectionEnd;o=u.value.substring(n,r);t=t+o+"</a>";i=n+t.length;if(n==r){i-="</a>".length}u.value=u.value.substring(0,n)+t+u.value.substring(r,u.value.length);u.selectionStart=u.selectionEnd=i}}wpLink.close();u.focus()},mceUpdate:function(){var e,n=wpLink.getAttrs();wpLink.close();t.focus();if(tinymce.isIE){t.selection.moveToBookmark(t.windowManager.bookmark)}e=t.dom.getParent(t.selection.getNode(),"a[href]");if(!n.href||n.href=="http://"){t.execCommand("unlink");return}if(e){t.dom.setAttribs(e,n)}else{t.execCommand("mceInsertLink",false,n)}t.selection.collapse()},updateFields:function(e,t){s.url.val(t.children(".item-permalink").val());s.title.val(t.hasClass("no-title")?"":t.children(".item-title").text())},setDefaultValues:function(){var e=t&&t.selection.getContent(),n=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i,r=/^(https?|ftp):\/\/[A-Z0-9.-]+\.[A-Z]{2,4}[^ "]*$/i;if(e&&n.test(e)){s.url.val("mailto:"+e)}else{if(e&&r.test(e)){s.url.val(e.replace(/&|&#0?38;/gi,"&"))}else{s.url.val("http://")}}s.title.val("");s.submit.val(wpLinkL10n.save)},searchInternalLinks:function(){var t=e(this),n,r=t.val();if(r.length>2){o.recent.hide();o.search.show();if(wpLink.lastSearch==r){return}wpLink.lastSearch=r;n=t.parent().find(".spinner").show();o.search.change(r);o.search.ajax(function(){n.hide()})}else{o.search.hide();o.recent.show()}},next:function(){o.search.next();o.recent.next()},prev:function(){o.search.prev();o.recent.prev()},keydown:function(t){var n,r,i=e.ui.keyCode;if(i.ESCAPE===t.keyCode){wpLink.close();t.stopImmediatePropagation()}else{if(i.TAB===t.keyCode){r=t.target.id;if(r==="wp-link-submit"&&!t.shiftKey){s.close.focus();t.preventDefault()}else{if(r==="wp-link-close"&&t.shiftKey){s.submit.focus();t.preventDefault()}}}}if(t.keyCode!==i.UP&&t.keyCode!==i.DOWN){return}if(document.activeElement&&(document.activeElement.id==="link-title-field"||document.activeElement.id==="url-field")){return}n=t.keyCode===i.UP?"prev":"next";clearInterval(wpLink.keyInterval);wpLink[n]();wpLink.keyInterval=setInterval(wpLink[n],wpLink.keySensitivity);t.preventDefault()},keyup:function(t){var n=e.ui.keyCode;if(t.which===n.UP||t.which===n.DOWN){clearInterval(wpLink.keyInterval);t.preventDefault()}},delayedCallback:function(e,t){var n,r,i,s;if(!t){return e}setTimeout(function(){if(r){return e.apply(s,i)}n=true},t);return function(){if(n){return e.apply(this,arguments)}i=arguments;s=this;r=true}},toggleInternalLinking:function(e){var t=s.wrap.hasClass("search-panel-visible");s.wrap.toggleClass("search-panel-visible",!t);setUserSetting("wplink",t?"0":"1");s[!t?"search":"url"].focus();e.preventDefault()}};r=function(t,n){var r=this;this.element=t;this.ul=t.children("ul");this.contentHeight=t.children("#link-selector-height");this.waiting=t.find(".river-waiting");this.change(n);this.refresh();e("#wp-link .query-results, #wp-link #link-selector").scroll(function(){r.maybeLoad()});t.on("click","li",function(t){r.select(e(this),t)})};e.extend(r.prototype,{refresh:function(){this.deselect();this.visible=this.element.is(":visible")},show:function(){if(!this.visible){this.deselect();this.element.show();this.visible=true}},hide:function(){this.element.hide();this.visible=false},select:function(e,t){var n,r,i,s;if(e.hasClass("unselectable")||e==this.selected){return}this.deselect();this.selected=e.addClass("selected");n=e.outerHeight();r=this.element.height();i=e.position().top;s=this.element.scrollTop();if(i<0){this.element.scrollTop(s+i)}else{if(i+n>r){this.element.scrollTop(s+i-r+n)}}this.element.trigger("river-select",[e,t,this])},deselect:function(){if(this.selected){this.selected.removeClass("selected")}this.selected=false},prev:function(){if(!this.visible){return}var e;if(this.selected){e=this.selected.prev("li");if(e.length){this.select(e)}}},next:function(){if(!this.visible){return}var t=this.selected?this.selected.next("li"):e("li:not(.unselectable):first",this.element);if(t.length){this.select(t)}},ajax:function(e){var t=this,n=this.query.page==1?0:wpLink.minRiverAJAXDuration,r=wpLink.delayedCallback(function(n,r){t.process(n,r);if(e){e(n,r)}},n);this.query.ajax(r)},change:function(e){if(this.query&&this._search==e){return}this._search=e;this.query=new i(e);this.element.scrollTop(0)},process:function(t,n){var r="",i=true,s="",o=n.page==1;if(!t){if(o){r+='<li class="unselectable no-matches-found"><span class="item-title"><em>'+wpLinkL10n.noMatchesFound+"</em></span></li>"}}else{e.each(t,function(){s=i?"alternate":"";s+=this.title?"":" no-title";r+=s?'<li class="'+s+'">':"<li>";r+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />';r+='<span class="item-title">';r+=this.title?this.title:wpLinkL10n.noTitle;r+='</span><span class="item-info">'+this.info+"</span></li>";i=!i})}this.ul[o?"html":"append"](r)},maybeLoad:function(){var e=this,t=this.element,n=t.scrollTop()+t.height();if(!this.query.ready()||n<this.contentHeight.height()-wpLink.riverBottomThreshold){return}setTimeout(function(){var n=t.scrollTop(),r=n+t.height();if(!e.query.ready()||r<e.contentHeight.height()-wpLink.riverBottomThreshold){return}e.waiting.show();t.scrollTop(n+e.waiting.outerHeight());e.ajax(function(){e.waiting.hide()})},wpLink.timeToTriggerRiver)}});i=function(e){this.page=1;this.allLoaded=false;this.querying=false;this.search=e};e.extend(i.prototype,{ready:function(){return!(this.querying||this.allLoaded)},ajax:function(t){var n=this,r={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:s.nonce.val()};if(this.search){r.search=this.search}this.querying=true;e.post(ajaxurl,r,function(e){n.page++;n.querying=false;n.allLoaded=!e;t(e,r)},"json")}});e(document).ready(wpLink.FancyLink);e(document).ready(wpLink.init)})(jQuery)
